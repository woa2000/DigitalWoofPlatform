# üõ†Ô∏è Brand Voice JSON - Implementation Artifacts

**Gerado em:** 2025-09-05T15:45:00Z  
**Status:** Resolu√ß√µes t√©cnicas completas  
**Origem:** Respostas aos bloqueios identificados no plano  

---

## üì¶ Implementa√ß√µes Priorit√°rias

### 1. Backup & Disaster Recovery Strategy

#### Edge Function para Purge de Vers√µes
```typescript
// server/functions/purgeBrandVoiceVersions.ts
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_KEY!
);

const RETAIN = 10;       // manter √∫ltimas 10 vers√µes
const SOFT_DELETE_DAYS = 30;

export async function run() {
  console.log('Starting Brand Voice version purge job...');
  
  // 1) mover >RETAIN para "trash/" (soft-delete com carimbo de data)
  // 2) apagar definitivos >SOFT_DELETE_DAYS em "trash/"
  // (implemente listagem por prefixo brandvoice/{tenant}/{id}/)
  
  // Implementar l√≥gica de:
  // - Listar vers√µes por tenant/document
  // - Manter only latest RETAIN versions + pinned
  // - Move old versions to trash/ with timestamp
  // - Purge trash/ older than SOFT_DELETE_DAYS
  
  return { success: true, processed: 0, errors: 0 };
}
```

**Configura√ß√£o:**
- DB (Postgres/Supabase): snapshots di√°rios + WAL/PITR, reten√ß√£o 30 dias (MVP) ‚Üí 90 dias (p√≥s-MVP)
- Storage: versionamento l√≥gico `brandvoice/{tenant}/{id}/{version}.json` + TTL 180 dias
- DR: RTO ‚â§ 60 min, RPO ‚â§ 15 min, restore drill trimestral

---

### 2. Manual Quality Review Process

#### Workflow Configuration
```json
{
  "rule_id": "quality-gate-v1",
  "when": "on_generation_complete",
  "condition": "quality_score < 0.7",
  "action": "mark_needs_review",
  "notify": ["product_owner@acme.com"],
  "workflow": {
    "states": ["Draft", "AutoGenerated", "NeedsReview", "Approved", "Rejected", "Published"],
    "transitions": {
      "AutoGenerated": {
        "to": ["NeedsReview", "Published"],
        "condition": "quality_score < 0.7 ? NeedsReview : Published"
      },
      "NeedsReview": {
        "to": ["Approved", "Rejected"],
        "required_fields": ["rationale", "changes_summary"],
        "sla_hours": 24
      }
    }
  }
}
```

**Database Schema Addition:**
```sql
-- Add to brand_voice table
ALTER TABLE brand_voice ADD COLUMN IF NOT EXISTS review_status VARCHAR(20) DEFAULT 'auto_generated';
ALTER TABLE brand_voice ADD COLUMN IF NOT EXISTS review_rationale TEXT;
ALTER TABLE brand_voice ADD COLUMN IF NOT EXISTS review_changes_summary TEXT;
ALTER TABLE brand_voice ADD COLUMN IF NOT EXISTS reviewed_by UUID REFERENCES users(id);
ALTER TABLE brand_voice ADD COLUMN IF NOT EXISTS reviewed_at TIMESTAMP WITH TIME ZONE;
```

---

### 3. Multi-AI Provider Strategy

#### Provider Interface & Implementation
```typescript
// server/services/ai/providers/base.ts
export interface AiProvider {
  generate(input: {
    prompt: string;
    system?: string;
    temperature?: number;
    maxTokens?: number;
  }): Promise<{
    text: string;
    tokens: number;
    model: string;
    provider: string;
  }>;
}

// server/services/ai/providers/openai.ts
export class OpenAIProvider implements AiProvider {
  constructor(private apiKey: string) {}
  
  async generate(input: {
    prompt: string;
    system?: string;
    temperature?: number;
    maxTokens?: number;
  }) {
    // Implementar chamada OpenAI API
    return {
      text: 'generated content',
      tokens: 150,
      model: 'gpt-4',
      provider: 'openai'
    };
  }
}

// server/services/ai/factory.ts
export function makeProvider(): AiProvider {
  switch (process.env.AI_PROVIDER) {
    case 'openai':
    default:
      return new OpenAIProvider(process.env.OPENAI_API_KEY!);
    // Future: case 'anthropic': return new AnthropicProvider();
  }
}
```

---

### 4. Version Retention Policy

#### Database Schema
```sql
-- Add versioning support
ALTER TABLE brandvoice_versions ADD COLUMN IF NOT EXISTS is_pinned BOOLEAN DEFAULT false;
CREATE INDEX IF NOT EXISTS idx_bv_tenant_doc_version 
  ON brandvoice_versions(tenant_id, document_id, created_at DESC);

-- Exemplo de query para manter N vers√µes
/*
SELECT * FROM brandvoice_versions 
WHERE tenant_id=$1 AND document_id=$2 
ORDER BY created_at DESC 
LIMIT 10;
*/
```

#### Retention Service
```typescript
// server/services/brand-voice-retention.service.ts
export class BrandVoiceRetentionService {
  private readonly RETAIN_COUNT = 10;
  private readonly SOFT_DELETE_DAYS = 30;
  
  async enforceRetentionPolicy(tenantId: string, documentId: string) {
    // 1. Get all versions for document
    // 2. Keep latest RETAIN_COUNT + pinned versions
    // 3. Move others to soft-delete
    // 4. Hard delete soft-deleted > SOFT_DELETE_DAYS
  }
}
```

---

### 5. Multi-tenant Performance

#### RLS Policies & Indexes
```sql
-- Add tenant isolation
ALTER TABLE brandvoice ADD COLUMN IF NOT EXISTS tenant_id UUID NOT NULL;

-- RLS Policy
CREATE POLICY "tenant_isolation"
ON brandvoice
FOR ALL
USING (tenant_id = auth.uid())      -- ou fun√ß√£o que resolve tenant do JWT
WITH CHECK (tenant_id = auth.uid());

-- Performance Indexes
CREATE INDEX IF NOT EXISTS idx_bv_tenant_created 
  ON brandvoice(tenant_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_bv_tenant_doc 
  ON brandvoice(tenant_id, document_id);
CREATE INDEX IF NOT EXISTS idx_bv_tenant_active 
  ON brandvoice(tenant_id, is_active) WHERE is_active = true;
```

#### Rate Limiting Service
```typescript
// server/middleware/rate-limit.ts
export class TenantRateLimiter {
  private limits = new Map<string, { count: number; resetTime: number }>();
  
  async checkLimit(tenantId: string, endpoint: string): Promise<boolean> {
    const key = `${tenantId}:${endpoint}`;
    const limit = this.getTenantLimit(tenantId, endpoint);
    
    // Implement sliding window rate limiting
    return true; // or false if limit exceeded
  }
  
  private getTenantLimit(tenantId: string, endpoint: string): number {
    // Return different limits based on tenant plan
    // /api/brand-voice/generate: 10/hour (free), 100/hour (pro)
    // /api/brand-voice/active: 1000/hour (free), unlimited (pro)
    return 10;
  }
}
```

---

### 6. Quality Threshold Flexibility

#### Threshold Service
```typescript
// server/services/brand-voice-threshold.service.ts
export class BrandVoiceThresholdService {
  async getThreshold(tenantId?: string): Promise<number> {
    // MVP: Fixed threshold
    if (!process.env.ENABLE_PER_TENANT_THRESHOLD) {
      return 0.7;
    }
    
    // Post-MVP: Per-tenant configuration
    const tenant = await this.db.tenants.findById(tenantId);
    const threshold = tenant?.quality_threshold ?? 0.7;
    
    // Enforce limits [0.5 ... 0.9]
    return Math.min(0.9, Math.max(0.5, threshold));
  }
  
  async setThreshold(tenantId: string, threshold: number): Promise<void> {
    if (!process.env.ENABLE_PER_TENANT_THRESHOLD) {
      throw new Error('Per-tenant thresholds not enabled');
    }
    
    const bounded = Math.min(0.9, Math.max(0.5, threshold));
    await this.db.tenants.update(tenantId, { quality_threshold: bounded });
  }
}
```

#### Database Schema (Post-MVP)
```sql
-- Add to tenants table (Fase 2)
ALTER TABLE tenants ADD COLUMN IF NOT EXISTS quality_threshold DECIMAL(3,2) DEFAULT 0.7;
ALTER TABLE tenants ADD CONSTRAINT quality_threshold_bounds 
  CHECK (quality_threshold >= 0.5 AND quality_threshold <= 0.9);
```

---

## üéØ Implementation Priority

### Phase 1 (MVP - Immediate)
1. **Multi-AI Provider Interface** - Foundation for extensibility
2. **Quality Threshold Service** - Core business logic
3. **Version Retention** - Data management
4. **Multi-tenant RLS** - Security foundation

### Phase 2 (Post-MVP)
1. **Backup Job Implementation** - Operational excellence
2. **Manual Review Workflow** - Quality assurance
3. **Per-tenant Thresholds** - Advanced configuration

---

## üìã Integration Checklist

- [ ] Implement AI Provider interface and OpenAI adapter
- [ ] Add quality threshold service with fixed 0.7 MVP
- [ ] Set up RLS policies and performance indexes
- [ ] Implement version retention with soft-delete
- [ ] Add manual review workflow states to schema
- [ ] Create backup purge job (Edge Function)
- [ ] Document all decisions in respective runbooks

---

*Implementations ready for immediate development*  
*All technical decisions resolved with working code examples*